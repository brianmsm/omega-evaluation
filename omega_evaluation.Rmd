---
title: "Omega coefficient evaluation"
author: 
  - name: Brian N. Pe√±a-Calero
    email: brianmsm@gmail.com
output: 
  html_notebook: 
    toc: yes
    highlight: kate
    theme: flatly
    number_sections: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations for analysis

Loading packages to simulate and manipulate data. You need to have the `pacman` package installed. If you do not have it, try this `install.packages("pacman")`.
```{r}
pacman::p_load(tidyverse, lavaan, arrow, multidplyr, cli)
# pacman::p_load_gh("matherion/userfriendlyscience")
```

# Import data

Using same data generated by previous research.

```{r}
# load("Simulation_data_tidy_rep.RData")
```

```{r}
# items3 <- open_dataset("data/items=3 items/")
```


# Reliability analysis


The `multidplyr` package will be used so that the calculation uses all the processor cores.

```{r}
cluster <- new_cluster(parallel::detectCores() - 2)

cluster_library(cluster, "dplyr")
cluster_library(cluster, "purrr")
cluster_library(cluster, "lavaan")
cluster_library(cluster, "semTools")
```


```{r}

datasets <- str_sort(fs::dir_ls("data/"), numeric = TRUE)

execution_time <- tibble(
  Items = as.character(),
  start_time = as.POSIXct(character()),
  end_time = as.POSIXct(character()),
  diff_time = hms::as_hms(character())
)

for (i in seq_along(datasets)) {
  
  which_items_data <- str_remove(datasets[i], "data/items=")
  
  items_dataset <- open_dataset(datasets[i])
  items_dataset <- items_dataset %>% 
    collect() %>% 
    mutate(items = which_items_data) %>% 
    partition(cluster)
  
  cli_h1(which_items_data)
  
  cli_alert_info(
    paste0("Starting with ", which_items_data, " at ",
             hms::round_hms(hms::as_hms(Sys.time()), digits = 0),
             ".\n")
  )
  
  start_time <- Sys.time()
  
  items_reliability <- items_dataset %>% 
    mutate(
      data = map(data,
                 ~ select(., tidyselect:::where(~ !all(is.na(.))))),
      
      # Continous items
      model_cfa1 = map_chr(data,
                           ~ paste0(
                             "F1 =~ ",
                             .x %>% 
                               select(-ends_with("Item")) %>% 
                               names() %>% 
                               paste(collapse = " + ")
                              )),
      fit_cfa1 = map2(data, model_cfa1,
                      ~ cfa(model = .y,
                            data = .x)),
      converged1 = map_lgl(fit_cfa1,
                           ~ lavInspect(.x, "converged")),
      validity1 = map_lgl(fit_cfa1,
                          ~ suppressWarnings(
                            lavInspect(.x, "post.check")
                          )),
      fit_measures1 = map(fit_cfa1,
                          ~ antools::fit_lavaan(.x)),
      omega2_1 = map_dbl(fit_cfa1,
                         ~ reliability(.x, "omega2")[1]),
  
      # Ordinal items
      model_cfa2 = map_chr(data,
                           ~ paste0(
                             "F1 =~ ",
                             .x %>%
                               select(ends_with("Item")) %>%
                               names() %>%
                               paste(collapse = " + ")
                             )),
      fit_cfa2 = map2(data, model_cfa2,
                      ~ cfa(model = .y,
                            data = .x,
                            ordered = TRUE,
                            estimator = "WLSMV")),
      converged2 = map_lgl(fit_cfa2,
                           ~ lavInspect(.x, "converged")),
      validity2 = map_lgl(fit_cfa2,
                          ~ suppressWarnings(
                            lavInspect(.x, "post.check")
                          )),
      fit_measures2 = map(fit_cfa2,
                          ~ antools::fit_lavaan(.x)),
      omega2_2 = map_dbl(fit_cfa2,
                         ~ reliability(.x, "omega2")[1])
    ) %>% 
    collect()
  
  end_time <- Sys.time()
  
  diff_time <- difftime(end_time, start_time, units = "sec")
  diff_time <- hms::hms(lubridate::seconds_to_period(diff_time))
  
  cli_alert_success(
    paste0("The analysis of the ", which_items_data, 
             " data has been finalized after ",
             hms::round_hms(diff_time, digits = 0),
             " hours at ",
             hms::round_hms(hms::as_hms(Sys.time()), digits = 0),
             ".\n")
  )
  
  execution_time <- execution_time %>% 
    add_case(
      Items = which_items_data,
      start_time,
      end_time,
      diff_time
    ) 
  
  cli_alert_info("Starting to write parquet files...")

  items_reliability %>% 
    saveRDS(file = fs::path("output", 
                            paste0(which_items_data, 
                                   " omega.rds")))
  
  cli_alert_success("Parquet files was writed.\n")
  
  cli_alert_info("Cleaning up ram memory...\n")
  
  gc()
  
  cli_alert_success("Done!\n")
  
}
```


Export exection time logging.

```{r}
execution_time

saveRDS(execution_time,
        file = "output/execution_time.rds")
```



